<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/main/java/services/ServicioContribuciones.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/services/ServicioContribuciones.java" />
              <option name="originalContent" value="package services;&#10;&#10;import domain.*;&#10;import dtos.input.ArchivoInputDTO;&#10;import dtos.input.ContribucionInputDTO;&#10;import dtos.input.HechoInputDTO;&#10;import dtos.input.UbicacionInputDTO;&#10;import dtos.output.*;&#10;import mappers.ArchivoMapper;&#10;import mappers.ContribucionMapper;&#10;import mappers.HechoMapper;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.stereotype.Service;&#10;import repository.IContribucionesRepository;&#10;&#10;import java.time.LocalDate;&#10;&#10;@Service&#10;public class ServicioContribuciones {&#10;    @Autowired&#10;    private IContribucionesRepository repositorio;&#10;    final private PoliticaEdicion politicaEdicion= new PoliticaEdicion();&#10;    @Autowired&#10;    private ServicioContribuyente servicioContribuyente;&#10;    private HechoMapper hechoMapper = new HechoMapper();&#10;    private ArchivoMapper archivoMapper = new ArchivoMapper();&#10;    private ContribucionMapper contribucionMapper = new ContribucionMapper();&#10;&#10;    public Long crear(ContribucionInputDTO contribucionInputDTO){&#10;        Hecho hecho = hechoMapper.hechoDtoToHecho(contribucionInputDTO.getHecho());&#10;        Contribucion contribucion = new Contribucion();&#10;        contribucion.setHecho(hecho);&#10;        contribucion.getRevision().setContribucion(contribucion);&#10;        contribucion.setFechaDeCarga(LocalDate.now()); // Establecer la fecha de carga al crear&#10;&#10;        Contribuyente contribuyente = servicioContribuyente.buscarContribuyente(contribucionInputDTO.getIdContribuyente());&#10;&#10;        contribucion.setContribuyente(contribuyente);&#10;        repositorio.guardar(contribucion);&#10;        return contribucion.getId();&#10;    };&#10;&#10;    public void editar(long idContribucion, HechoInputDTO dto){&#10;        Contribucion contribucion = repositorio.buscarPorId(idContribucion);&#10;        &#10;        // Si la contribución no tiene fechaDeCarga (fue creada antes del cambio), establecerla ahora&#10;        if (contribucion.getFechaDeCarga() == null) {&#10;            contribucion.setFechaDeCarga(LocalDate.now());&#10;        }&#10;        &#10;        if (politicaEdicion.puedeEditar(contribucion.getFechaDeCarga())){&#10;            Hecho hecho = hechoMapper.hechoDtoToHecho(dto);&#10;            contribucion.setHecho(hecho);&#10;            contribucion.getRevision().setEstado(EstadoRevision.PENDIENTE);&#10;        } else {&#10;            throw new RuntimeException(&quot;No se puede editar la contribucion despues de 7 dias.&quot;);&#10;        }&#10;    }&#10;&#10;    public void adjuntarArchivo(long idContribucion, ArchivoInputDTO dto){&#10;        Contribucion contribucion = repositorio.buscarPorId(idContribucion);&#10;        Archivo archivo = archivoMapper.archivoDtoToArchivo(dto);&#10;        contribucion.getHecho().setAdjunto(archivo);&#10;    }&#10;&#10;    public ContribucionOutputDTO obtener(long id){&#10;        Contribucion c = repositorio.buscarPorId(id);&#10;        ContribucionOutputDTO dto = contribucionMapper.contribucionToOutputDTO(c);&#10;        return dto;&#10;    }&#10;&#10;&#10;}&#10;" />
              <option name="updatedContent" value="package services;&#10;&#10;import domain.*;&#10;import dtos.input.ArchivoInputDTO;&#10;import dtos.input.ContribucionInputDTO;&#10;import dtos.input.HechoInputDTO;&#10;import dtos.input.UbicacionInputDTO;&#10;import dtos.output.*;&#10;import mappers.ArchivoMapper;&#10;import mappers.ContribucionMapper;&#10;import mappers.HechoMapper;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.stereotype.Service;&#10;import repository.IContribucionesRepository;&#10;&#10;import java.time.LocalDate;&#10;&#10;@Service&#10;public class ServicioContribuciones {&#10;    @Autowired&#10;    private IContribucionesRepository repositorio;&#10;    final private PoliticaEdicion politicaEdicion= new PoliticaEdicion();&#10;    @Autowired&#10;    private ServicioContribuyente servicioContribuyente;&#10;    private HechoMapper hechoMapper = new HechoMapper();&#10;    private ArchivoMapper archivoMapper = new ArchivoMapper();&#10;    private ContribucionMapper contribucionMapper = new ContribucionMapper();&#10;&#10;    public Long crear(ContribucionInputDTO contribucionInputDTO){&#10;        Hecho hecho = hechoMapper.hechoDtoToHecho(contribucionInputDTO.getHecho());&#10;        Contribucion contribucion = new Contribucion();&#10;        contribucion.setHecho(hecho);&#10;        contribucion.getRevision().setContribucion(contribucion);&#10;        contribucion.setFechaDeCarga(LocalDate.now()); // Establecer la fecha de carga al crear&#10;&#10;        Contribuyente contribuyente = servicioContribuyente.buscarContribuyente(contribucionInputDTO.getIdContribuyente());&#10;&#10;        contribucion.setContribuyente(contribuyente);&#10;        repositorio.guardar(contribucion);&#10;        return contribucion.getId();&#10;    };&#10;&#10;    public void editar(long idContribucion, HechoInputDTO dto){&#10;        Contribucion contribucion = repositorio.buscarPorId(idContribucion);&#10;        &#10;        // Si la contribución no tiene fechaDeCarga (fue creada antes del cambio), establecerla ahora&#10;        if (contribucion.getFechaDeCarga() == null) {&#10;            contribucion.setFechaDeCarga(LocalDate.now());&#10;        }&#10;        &#10;        if (politicaEdicion.puedeEditar(contribucion.getFechaDeCarga())){&#10;            Hecho hecho = hechoMapper.hechoDtoToHecho(dto);&#10;            contribucion.setHecho(hecho);&#10;            contribucion.getRevision().setEstado(EstadoRevision.PENDIENTE);&#10;        } else {&#10;            throw new RuntimeException(&quot;No se puede editar la contribucion despues de 7 dias.&quot;);&#10;        }&#10;    }&#10;&#10;    public void adjuntarArchivo(long idContribucion, ArchivoInputDTO dto){&#10;        Contribucion contribucion = repositorio.buscarPorId(idContribucion);&#10;        Archivo archivo = archivoMapper.archivoDtoToArchivo(dto);&#10;        contribucion.getHecho().setAdjunto(archivo);&#10;    }&#10;&#10;    public ContribucionOutputDTO obtener(long id){&#10;        Contribucion c = repositorio.buscarPorId(id);&#10;        ContribucionOutputDTO dto = contribucionMapper.contribucionToOutputDTO(c);&#10;        return dto;&#10;    }&#10;&#10;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>